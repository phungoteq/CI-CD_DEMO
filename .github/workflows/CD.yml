name: CD_Demo

on:
  push:
    branches: 

jobs:
  prebuild:
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.extract-release-notes.outputs.content }}
      branch_name: ${{ steps.get-branch-name.outputs.name }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract release notes
      id: extract-release-notes
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        NOTES=$(git tag -l --format='%(contents)' "$TAG_NAME")
        echo "content=$NOTES" >> $GITHUB_OUTPUT

    - name: Get branch name
      id: get-branch-name
      run: |
        BRANCH=${GITHUB_REF#refs/heads/}
        echo "name=$BRANCH" >> $GITHUB_OUTPUT

  unit-test:
    needs: prebuild
    runs-on: ubuntu-latest
    outputs:
      test_status: ${{ steps.run-tests.outputs.result }}
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: poetry install --no-interaction
    
    - name: Run tests
      id: run-tests
      continue-on-error: true
      run: |
        if poetry run pytest; then
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "result=failure" >> $GITHUB_OUTPUT
        fi

  manual-approval:
    needs: unit-test
    if: ${{ needs.unit-test.outputs.test_status == 'failure' }}
    runs-on: ubuntu-latest
    environment:
      name: production-approval
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
    - name: Require approval
      run: echo "Manual approval required for deployment"

  deploy:
    needs:
      - prebuild
      - unit-test
      - manual-approval
    if: |
      (needs.unit-test.outputs.test_status == 'success') ||
      (needs.unit-test.outputs.test_status == 'failure' && needs.manual-approval.result == 'success')
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deployment setup
      run: echo "Deploying version ${{ github.ref_name }}"
    
    - name: Show deployment info
      run: |
        echo "Branch: ${{ needs.prebuild.outputs.branch_name }}"
        echo "Release notes: ${{ needs.prebuild.outputs.release_notes }}"
