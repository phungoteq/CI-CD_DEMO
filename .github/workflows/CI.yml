name: CI
on:
  push:
    branches:
      - master
    tags:
      - 'feature-*'
  pull_request:
    types: [opened, synchronize]
    branches:
      - master

jobs:
  lint_test:
    name: Lint and Test
    runs-on: ubuntu-latest
    outputs:
      test_passed: ${{ steps.test_status.outputs.passed }}
      is_tag: ${{ steps.check_tag.outputs.is_tag }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Check if triggered by tag
        id: check_tag
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install poetry
        run: |
          curl -sSL https://install.python-poetry.org | python - --version 1.8.2
          echo "$HOME/.poetry/bin" >> $GITHUB_PATH

      - name: Poetry Install Dependencies
        run: poetry install

      - name: create .env file
        run: cp .env.example .env

      - name: lint
        continue-on-error: true
        run: make lint

      - name: format
        continue-on-error: true
        run: make format

      - name: Run tests
        id: test_status
        continue-on-error: true
        run: |
          if make test; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

  manual-approval:
    needs: [lint_test]
    runs-on: ubuntu-latest
    if: |
      needs.lint_test.outputs.test_passed == 'false' &&
      (needs.lint_test.outputs.is_tag == 'true' || github.event_name == 'pull_request')
    environment: 
      name: test-approval
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Manual Approval for Failed Tests
        run: |
          if [[ "${{ needs.lint_test.outputs.is_tag }}" == "true" ]]; then
            echo "Manual approval required for tag deployment with failed tests..."
          else
            echo "Manual approval required for PR with failed tests..."
          fi

  merge-check:
    needs: [lint_test, manual-approval]
    runs-on: ubuntu-latest
    if: |
      always() &&
      (needs.lint_test.outputs.test_passed == 'true' ||
       (needs.lint_test.outputs.test_passed == 'false' && needs.manual-approval.result == 'success'))
    steps:
      - name: Check Status
        run: |
          if [[ "${{ needs.lint_test.outputs.is_tag }}" == "true" ]]; then
            echo "ğŸ·ï¸ Processing tag: ${GITHUB_REF#refs/tags/}"
          else
            echo "ğŸ”„ Processing branch: ${GITHUB_REF#refs/heads/}"
          fi

          if [[ "${{ needs.lint_test.outputs.test_passed }}" == "true" ]]; then
            echo "âœ… All tests passed successfully!"
          else
            echo "âš ï¸ Tests failed but manually approved to proceed."
          fi

      - name: Tag Status
        if: needs.lint_test.outputs.is_tag == 'true'
        run: |
          echo "Tag validation completed"
          echo "Tag: ${GITHUB_REF#refs/tags/}"
